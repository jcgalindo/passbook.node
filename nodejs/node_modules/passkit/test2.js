/*
*  Create by Juan Carlos Galindo Navarro
*
 */

var unirest = require('unirest');
var restify = require('restify');

var Request = unirest.get("https://passkit-passkit.p.mashape.com/authenticate")
    .headers({
        "X-Mashape-Authorization": "j6WhcWg1sRkXfpz7wBtdQxFdtAW7jSb9"
    })
    .end(function (response) {
        //console.log(response);
    });






var ip_addr = '127.0.0.1';
var port = '8080';

var server = restify.createServer({
    name: "myapp",
    formatters: {
        'application/json': function(req, res, body){
            if(req.params.callback){
                var callbackFunctionName = req.params.callback.replace(/[^A-Za-z0-9_\.]/g, '');
                return callbackFunctionName + "(" + JSON.stringify(body) + ");";
            } else {
                return JSON.stringify(body);
            }
        },
        'text/html': function(req, res, body){
            return body;
        }
    }
});

server.use(restify.queryParser());
server.use(restify.bodyParser());
server.use(restify.CORS());

var PATH = '/createPass'
server.get({path: PATH + '/:data1', version: '0.0.1'}, createPass);


server.listen(port, ip_addr, function () {
    console.log('%s listening at %s ', server.name, server.url);
});


function createPass(req, res, next) {
    res.setHeader('Access-Control-Allow-Origin', '*');

    unirest.put("https://passkit-passkit.p.mashape.com/pass/issue/template/POC Passkit")
        .headers({
            "X-Mashape-Authorization": "j6WhcWg1sRkXfpz7wBtdQxFdtAW7jSb9",
            "Content-Type": "application/json"
        })
        .send('{"data1":' + req.params.data1 + ', "data2":"888"}')
        .end(function (response) {

            var r = '{"passKIt": ' + response.body.url +'}';

            res.writeHead(200, {
                'Content-Length': Buffer.byteLength(r),
                'Content-Type': 'application/json'
            });
            res.write(r);
            res.end();

            return response;
        });

}